# üöÄ Simple HubSpot-to-Snowflake ETL

This project is a simple ETL (Extract, Transform, Load) process that demonstrates how to:

1.  Populate a HubSpot developer sandbox with realistic sample data (Companies, Contacts, and both B2B/B2C Deals).
2.  Extract this data using the HubSpot REST API.
3.  Transform the data with Pandas.
4.  Load the cleaned data into `DEALS` and `LEADS` tables in Snowflake.
5.  Analyze the results in Snowflake to measure the ratio of B2B vs. B2C deals.

-----

## üîß 1. Configuration

This is the most important section. The project will not run without these environment variables.

### A. `.env` File

First, create your local environment file by copying the example:

```bash
cp .env.example .env
```

Now, open the `.env` file and fill in the following variables.

### B. HubSpot Configuration

You will need a **Private App Access Token**.

1.  **Create a Developer Sandbox:**

      * Go to the [HubSpot Developer](https://developers.hubspot.com/get-started) page and sign up for a free developer account. This will give you an isolated sandbox (testing environment).

2.  **Create a Private App:**

      * Inside your **new HubSpot sandbox**, navigate to **Settings** (‚öôÔ∏è icon) \> **Integrations** \> **Private Apps**.
      * Click "Create a new private app" and give it a name (e.g., "Snowflake\_ETL\_App").

3.  **Set Scopes (Critical Step):**

      * Go to the **"Scopes"** tab for your new app. This is the most common point of failure.
      * You **must** grant the following permissions for the `seed.py` (write) and `etl.py` (read) scripts to work:
          * `crm.objects.companies.write`
          * `crm.objects.contacts.write`
          * `crm.objects.deals.write`
          * `crm.objects.companies.read`
          * `crm.objects.contacts.read`
          * `crm.objects.deals.read`

4.  **Get Your Access Token:**

      * After saving the scopes, go to the **"Auth"** tab.
      * Click "Show token" and copy the generated **Access Token**.

5.  **Update `.env`:**

      * Paste this token into the `HUBSPOT_API_KEY` variable in your `.env` file.

### C. Snowflake Configuration

This project uses the [Snowflake Connector for Python](https://docs.snowflake.com/en/developer-guide/python-connector/python-connector) to connect.

1.  Log in to your Snowflake account.
2.  Find your account details. You will need your:
      * **User/Password**: Your login credentials.
      * **Account Identifier**: The first part of your Snowflake URL.
      * **Warehouse, Database, and Schema**: The compute resource and data locations you want to use.
3.  **Update `.env`:**
      * Fill in the following variables in your `.env` file based on your account:
          * `SNOW_USER=USERNAME`
          * `SNOW_PASSWORD=YourPassword`
          * `SNOW_ACCOUNT=XXXXX-XXXXXX`
          * `SNOW_WAREHOUSE=COMPUTE_WH`
          * `SNOW_DATABASE=SNOWFLAKE_LEARNING_DB`
          * `SNOW_SCHEMA=PUBLIC`

-----

### D. API Enviroment Variables Configuration

The API has its own set of environment variables that you need to configure in your `.env` file. These are used for authentication and for generating magic links for login.

  * `API_NAME`: The name of your API (e.g., "Simple ETL API").

  * `BASE_API_DOMAIN`: The base domain where your API is hosted (e.g., "http://localhost:8000"). This is used to construct the magic links for login.

  * `JWT_SECRET_KEY`: A secret key for signing JWTs. You can generate one with `openssl rand -hex 32`.

  * `JWT_ALGORITHM`: The algorithm to use for signing JWTs (e.g., "HS256").

  * `JWT_ACCESS_TOKEN_EXPIRE_MINUTES`: The number of minutes after which a JWT expires (e.g., 30).

  * `GMAIL_USER`: Your Gmail email address (e.g., "developer@gmail.com").

  * `GMAIL_APP_PASSWORD`: The app password generated by Google.

### How to get the GMAIL\_APP\_PASSWORD

For the API to send authentication "magic links" from your Gmail account, you cannot use your normal login password. You must generate a specific "App Password".

Critical Requirement: You must have 2-Step Verification (2FA) enabled on your Google account to create app passwords.

1.  Enable 2-Step Verification (if you haven't already):

      * Go to your Google account settings: [myaccount.google.com/security](https://myaccount.google.com/security).

      * In the "Signing in to Google" section, click on "2-Step Verification" and follow the on-screen instructions to enable it.

2.  Generate the App Password:

      * Once 2FA is activated, return to [myaccount.google.com/security](https://www.google.com/search?q=httpss://myaccount.google.com/security).

      * In the same "Signing in to Google" section, you should now see the "App passwords" option. Click on it. (You may need to sign in again).

      * In the "Select app" dropdown menu, choose "Mail".

      * In the "Select device" dropdown, choose "Other (Custom name...)".

      * Type a descriptive name for the app (e.g., "HubSpot ETL API" or "FastAPI Magic Link") and click "Generate".

3.  Use the Generated Password:

      * Google will display a 16-character password in a yellow box.

      * Copy this 16-character password. This is your GMAIL\_APP\_PASSWORD. (Do not lose it; Google will not show it to you again).

      * Paste it directly into the GMAIL\_APP\_PASSWORD variable in your .env file.

4.  Configure your Email:

      * Ensure that the GMAIL\_USER variable in your .env is the full email address of the Gmail account you used to generate the password (e.g., your-email@gmail.com).

-----

## ‚öôÔ∏è 2. Python Environment Setup

You must install the project dependencies in a virtual environment.

1.  **Create the virtual environment:**

    ```bash
    python3 -m venv venv
    ```

2.  **Activate the environment:**

      * On macOS / Linux:
        ```bash
        source venv/bin/activate
        ```
      * On Windows:
        ```bash
        .\venv\Scripts\activate
        ```

3.  **Install all required dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

-----

## ‚ñ∂Ô∏è 3. Run the Scripts

You must run these scripts in order.

### Step 1: Populate HubSpot (Seeding)

This script will populate your HubSpot sandbox with realistic test data (5 Companies, 15 Contacts, and 15 Deals). It randomly creates B2B deals (associated with a company) and B2C deals (associated only with a contact).

```bash
python3 suite/seed.py
```

### Step 2: Run the ETL

This script connects to the HubSpot API, extracts the data you just created, transforms it with Pandas (capturing the `associated_company_id`), and loads it into `DEALS` and `LEADS` tables in Snowflake.

```bash
python3 suite/etl.py
```

-----

## üìä 4. Analyze in Snowflake

If the ETL was successful, you will have two new tables (`DEALS` and `LEADS`) in the database and schema you specified.

1.  Navigate to your database and schema in the Snowflake UI.
2.  Open a new [SQL Worksheet](https://docs.snowflake.com/en/user-guide/ui-snowsight-worksheets-gs).
3.  Run the following query to verify the B2B vs. B2C data:

> **Note:** The `write_pandas` tool automatically uppercases column names. Your query must use `ASSOCIATED_COMPANY_ID` (all caps).

```sql
SELECT
    COUNT(CASE WHEN ASSOCIATED_COMPANY_ID IS NOT NULL THEN 1 END) AS total_deals_b2b,
    COUNT(CASE WHEN ASSOCIATED_COMPANY_ID IS NULL THEN 1 END)     AS total_deals_b2c,
    COUNT(*) AS total_deals
FROM
    DEALS;
```

-----

## üß™ 5. Run Unit Tests

Before running the main application, you can verify that the core services (Email and Snowflake) are configured correctly by running their unit tests.

```bash
# Test the email service
python -m unittest ./api/tests/email_test.py -v

# Test the Snowflake service
python -m unittest ./api/tests/snowflake_test.py -v
```

You can run all by:

```bash
python -m unittest discover -s api/tests -p "*_test.py" -v
```


-----

## üöÄ 6. Run the API

This project includes a simple API to expose the ETL results.

### Step 1: Run the API

To run the API, you need to have `uvicorn` installed (`pip install uvicorn`). Then, from the root of the project, run:

```bash
uvicorn api.main:app --reload
```

The API will be available at `http://localhost:8000`.

### Step 2: Authenticate with the API

The API uses a "magic link" authentication system. To authenticate, you need to follow these steps:

1.  **Request a magic link:**

    Send a POST request to the `/log-in` endpoint with your email address.

    ```bash
    curl -X POST "http://localhost:8000/log-in" -H "Content-Type: application/json" -d '{"email": "your-email@example.com"}'
    ```

    This will send an email to the specified address with a magic link to log in. Since this is a local setup, the email will be printed to the console where you are running `uvicorn`.

2.  **Find the magic link from your email inbox:**

    Look for an email with a line that looks like this:

    ```
    http://localhost:8000/verify-login?token=...&email=your-email@example.com
    ```

    Click the link. It will open a new tab in your browser. This tab will display a JSON object containing your JWT:

    ```json
    {
      "access_token": "your-jwt",
      "token_type": "bearer"
    }
    ```

3.  **Use the JWT to access protected endpoints:**

    You can now use the JWT to access protected endpoints by including it in the `Authorization` header.

    ```bash
    curl -X GET "http://localhost:8000/users/me" -H "Authorization: Bearer your-jwt"
    ```

    This will return the email of the authenticated user.

    ```json
    {
      "authenticated_email": "your-email@example.com"
    }
    ```

4.  **Retieve Snowflake data from the API**

    ```bash
    curl -X GET "metrics/snowflake/deals/b2b-vs-b2c" -H "Authorization: Bearer your-jwt"
    ```

-----

## üèÅ Conclusion

This is a simple example of an ETL process with the intention of measuring B2B vs. B2C Deals in Marketing Operations by analyzing CRM association data.